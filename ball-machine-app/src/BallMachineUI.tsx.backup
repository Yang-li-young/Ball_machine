import React, { useState } from "react";

// çƒç»„æ•°æ®ç»“æ„ï¼ˆå†…éƒ¨ id ç”¨äºç¨³å®šæ€§ï¼Œæ˜¾ç¤ºåºå·ä½¿ç”¨æ•°ç»„ç´¢å¼•+1ï¼‰
const defaultGroup = (id: number) => ({
  id,
  interval: 2, // s, 1-6 step 0.5
  upperRpm: 3500, // 2000-7000 step 500
  lowerRpm: 3500, // 2000-7000
  pitch: 30, // 20-40 step 2
  direction: 0, // -50..50 step 5
});

interface Group {
  id: number;
  interval: number;
  upperRpm: number;
  lowerRpm: number;
  pitch: number;
  direction: number;
}

export default function BallMachineUI() {
  const [groups, setGroups] = useState<Group[]>([]);
  // selectedIndex ç”¨äºä¿è¯æ˜¾ç¤ºç¼–å·ä¸º 1,2,3...ï¼ˆåŸºäºæ•°ç»„ä½ç½®ï¼‰
  const [selectedIndex, setSelectedIndex] = useState(-1);
  const [running, setRunning] = useState(false);
  const [nav, setNav] = useState("ball-machine");

  // å®‰å…¨å–å€¼ - å¦‚æœæ²¡æœ‰é€‰ä¸­çƒç»„ï¼Œä½¿ç”¨é»˜è®¤å€¼æ˜¾ç¤ºå‚æ•°
  const selectedGroup = groups[selectedIndex] || {
    interval: 2,
    upperRpm: 3500,
    lowerRpm: 3500,
    pitch: 30,
    direction: 0,
  };

  function addGroup() {
    if (groups.length >= 14) {
      // æœ€å¤šæ”¯æŒ14ä¸ªçƒç»„
      return;
    }
    const newGroups = [...groups, defaultGroup(Date.now())];
    setGroups(newGroups);
    setSelectedIndex(newGroups.length - 1);
  }

  function removeSelected() {
    if (groups.length === 0) return;
    const newGroups = groups.filter((_, i) => i !== selectedIndex);
    setGroups(newGroups);
    // æ›´æ–°é€‰ä¸­ç´¢å¼•
    if (newGroups.length === 0) {
      setSelectedIndex(-1);
    } else {
      const newIndex = Math.min(selectedIndex, Math.max(0, newGroups.length - 1));
      setSelectedIndex(newIndex);
    }
  }

  function clearAll() {
    setGroups([]);
    setSelectedIndex(-1);
  }

  function updateSelected(partial: Partial<Group>) {
    setGroups(groups.map((g, i) => (i === selectedIndex ? { ...g, ...partial } : g)));
  }

  
  // ç®€æ˜“å¼€å§‹/åœæ­¢é€»è¾‘
  function toggleRun() {
    setRunning(!running);
  }

  return (
    <div style={{
      minHeight: '100vh',
      backgroundColor: '#f9fafb',
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      padding: '16px',
      color: '#1f2937'
    }}>
      {/* é¡¶éƒ¨ç¤ºæ„å›¾ */}
      <div style={{ width: '100%', maxWidth: '448px', marginTop: '8px' }}>
        <div style={{
          position: 'relative',
          backgroundColor: 'white',
          borderRadius: '12px',
          boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
          padding: '16px'
        }}>
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '8px'
          }}>
            <button style={{
              padding: '4px 12px',
              backgroundColor: '#e5e7eb',
              borderRadius: '4px',
              border: 'none',
              cursor: 'pointer'
            }}>Disconnect</button>
          </div>

          <div style={{ display: 'flex', justifyContent: 'center' }}>
            <div style={{
              position: 'relative',
              width: '288px',
              height: '256px',
              backgroundColor: '#bbf7d0',
              borderRadius: '8px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}>
              {/* ç½‘çº¿ï¼ˆä¸­çº¿ï¼‰ */}
              <div style={{
                position: 'absolute',
                left: 0,
                right: 0,
                top: '50%',
                transform: 'translateY(-50%)',
                height: '4px',
                backgroundColor: 'black'
              }}></div>

              {/* å·¦è¾¹çº¿ */}
              <div style={{
                position: 'absolute',
                left: '32px',
                top: '24px',
                bottom: '24px',
                width: '2px',
                backgroundColor: 'white',
                opacity: 0.9
              }}></div>

              {/* å³è¾¹çº¿ */}
              <div style={{
                position: 'absolute',
                right: '32px',
                top: '24px',
                bottom: '24px',
                width: '2px',
                backgroundColor: 'white',
                opacity: 0.9
              }}></div>

              {/* åº•çº¿ï¼ˆä¸Š/ä¸‹ï¼‰ - ç½‘çƒåœºåº”æœ‰ä¸¤æ¡åº•çº¿ */}
              <div style={{
                position: 'absolute',
                left: '32px',
                right: '32px',
                top: '24px',
                height: '2px',
                backgroundColor: 'white',
                opacity: 0.9
              }}></div>
              <div style={{
                position: 'absolute',
                left: '32px',
                right: '32px',
                bottom: '24px',
                height: '2px',
                backgroundColor: 'white',
                opacity: 0.9
              }}></div>

              {/* å‘çƒçº¿/æœåŠ¡çº¿ï¼ˆé è¿‘ä¸­åœºçš„ä¸¤æ¡çº¿ï¼‰ */}
              <div style={{
                position: 'absolute',
                left: '32px',
                right: '32px',
                top: '80px',
                height: '2px',
                backgroundColor: 'white',
                opacity: 0.9
              }}></div>
              <div style={{
                position: 'absolute',
                left: '32px',
                right: '32px',
                bottom: '80px',
                height: '2px',
                backgroundColor: 'white',
                opacity: 0.9
              }}></div>

              {/* ä¸­å¿ƒæœåŠ¡çº¿ï¼ˆå°†å‘çƒåŒºåˆ†å·¦å³çš„å‚ç›´çº¿ï¼‰- å»¶é•¿å¯¹é½å‘çƒçº¿ */}
              <div style={{
                position: 'absolute',
                top: '80px',
                bottom: '80px',
                left: '50%',
                transform: 'translateX(-50%)',
                width: '2px',
                backgroundColor: 'white',
                opacity: 0.9
              }}></div>

              {/* å‘çƒæœº 3Dæ—‹è½¬å®¹å™¨ */}
              <div
                style={{
                  position: 'absolute',
                  top: '24px',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  transformStyle: 'preserve-3d',
                  perspective: '1000px'
                }}
              >
                {/* å‘çƒæœºå›¾æ ‡ - Yè½´æ—‹è½¬ */}
                <div
                  style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    transform: `rotateY(${rotation}deg)`,
                    transformOrigin: 'center bottom',
                    transition: 'transform 0.3s ease',
                    width: '40px',
                    height: '40px'
                  }}
                >
                  <img
                    src="/img_ballmachine.png"
                    alt="å‘çƒæœº"
                    width="40"
                    height="40"
                    style={{
                      display: 'block',
                      transformOrigin: 'center bottom'
                    }}
                  />
                </div>

                {/* æ‰€æœ‰çƒç»„çš„ç®­å¤´ */}
                {groups.map((g, i) => {
                  const groupRotation = -g.direction;
                  const isSelected = i === selectedIndex;

                  // è®¡ç®—ç®­å¤´é•¿åº¦ï¼šåŸºäºè½¬é€Ÿ (2000-7000rpm æ˜ å°„åˆ° 80-140px)
                  const avgRpm = (g.upperRpm + g.lowerRpm) / 2;
                  const rpmLength = 80 + ((avgRpm - 2000) / 5000) * 60; // 80-140px based on RPM

                  // æ ¹æ®ä¿¯ä»°è§’åº¦è°ƒæ•´é•¿åº¦ (20-40åº¦ï¼Œè¶Šé«˜è§’åº¦ = ç®­å¤´è¶ŠçŸ­)
                  // æœ€å¤§è§’åº¦(40åº¦)æ—¶å‡å°‘30%é•¿åº¦
                  const pitchFactor = 1 - ((g.pitch - 20) / 20) * 0.3; // 0.7 to 1.0 factor
                  const arrowLength = rpmLength * pitchFactor;

                  return (
                    <div key={g.id}>
                      {/* ç®­å¤´ */}
                      <div
                        style={{
                          position: 'absolute',
                          top: '40px',
                          left: '50%',
                          width: isSelected ? '3px' : '2px',
                          height: `${arrowLength}px`,
                          backgroundColor: isSelected ? '#059669' : '#d1d5db',
                          transformOrigin: 'top center',
                          transition: 'all 0.3s ease',
                          transform: `
                            translateX(-50%)
                            rotate(${groupRotation}deg)
                          `,
                          zIndex: isSelected ? 10 : 1,
                          opacity: isSelected ? 1 : 0.7
                        }}
                      >
                        {/* ç®­å¤´å¤´éƒ¨ */}
                        <div
                          style={{
                            position: 'absolute',
                            bottom: '-8px',
                            left: '50%',
                            transform: 'translateX(-50%)',
                            width: 0,
                            height: 0,
                            borderLeft: isSelected ? '5px solid transparent' : '4px solid transparent',
                            borderRight: isSelected ? '5px solid transparent' : '4px solid transparent',
                            borderTop: isSelected ? '10px solid #059669' : '8px solid #d1d5db'
                          }}
                        />
                        {/* çƒç»„ç¼–å·åœ†å½¢æ ‡ç­¾ */}
                        <div
                          style={{
                            position: 'absolute',
                            bottom: '-20px',
                            left: '50%',
                            transform: `translateX(-50%) rotate(${-groupRotation}deg)`,
                            width: '18px',
                            height: '18px',
                            borderRadius: '50%',
                            backgroundColor: isSelected ? '#059669' : '#6b7280',
                            color: 'white',
                            fontSize: '9px',
                            fontWeight: isSelected ? 'bold' : 'normal',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: isSelected ? 11 : 2,
                            boxShadow: isSelected ? '0 2px 4px rgba(5, 150, 105, 0.3)' : '0 1px 2px rgba(0, 0, 0, 0.1)',
                            border: '2px solid rgba(255, 255, 255, 0.8)'
                          }}
                        >
                          {i + 1}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* å·¦å³å‘çƒç‚¹ï¼ˆç¤ºæ„ï¼‰ */}
              <div style={{
                position: 'absolute',
                left: '4px',
                top: '50%',
                transform: 'translateY(-50%)'
              }}>
                <div style={{
                  width: '24px',
                  height: '24px',
                  borderRadius: '50%',
                  backgroundColor: 'black'
                }}></div>
              </div>
              <div style={{
                position: 'absolute',
                right: '4px',
                top: '50%',
                transform: 'translateY(-50%)'
              }}>
                <div style={{
                  width: '24px',
                  height: '24px',
                  borderRadius: '50%',
                  backgroundColor: 'black'
                }}></div>
              </div>
            </div>
          </div>
        </div>

        {/* ä¸­éƒ¨çƒåŒºåŸŸä¸çƒç»„æ§åˆ¶ */}
        <div style={{
          marginTop: '16px',
          backgroundColor: 'white',
          borderRadius: '12px',
          boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
          padding: '16px'
        }}>
          <div style={{
            textAlign: 'center',
            padding: '12px',
            borderRadius: '6px',
            backgroundColor: '#fdf2f8',
            color: '#374151'
          }}>é¢„è®¾è®­ç»ƒæ–¹æ¡ˆ</div>

          <div style={{ marginTop: '16px' }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between',
              marginBottom: '8px'
            }}>
              <div style={{ fontSize: '14px', fontWeight: '500' }}>Serve Sequence</div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <button
                  onClick={clearAll}
                  disabled={groups.length === 0}
                  style={{
                    padding: '4px 12px',
                    backgroundColor: groups.length === 0 ? '#f9fafb' : '#fef2f2',
                    border: groups.length === 0 ? '1px solid #e5e7eb' : '1px solid #fecaca',
                    borderRadius: '6px',
                    fontSize: '12px',
                    color: groups.length === 0 ? '#9ca3af' : '#dc2626',
                    cursor: groups.length === 0 ? 'not-allowed' : 'pointer',
                    boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)'
                  }}
                  title="æ¸…é™¤æ‰€æœ‰çƒç»„"
                >
                  ä¸€é”®æ¸…é™¤
                </button>
                <button
                  onClick={addGroup}
                  disabled={groups.length >= 14}
                  style={{
                    padding: '4px 12px',
                    backgroundColor: groups.length >= 14 ? '#f9fafb' : 'white',
                    border: '1px solid #d1d5db',
                    borderRadius: '9999px',
                    boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                    fontSize: '20px',
                    cursor: groups.length >= 14 ? 'not-allowed' : 'pointer'
                  }}
                  title="Add group"
                >
                  +
                </button>
              </div>
            </div>

            {/* çƒç»„åŒºåŸŸï¼šæ— çƒç»„æ—¶æ˜¾ç¤ºæé†’ï¼Œæœ‰çƒç»„æ—¶æ˜¾ç¤ºçƒç»„ç¼–å· */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: groups.length === 0 ? '1fr' : 'repeat(7, 1fr)',
              gridTemplateRows: groups.length === 0 ? '1fr' : 'repeat(2, 1fr)',
              gap: '12px',
              alignItems: 'center',
              marginBottom: '16px',
              justifyItems: 'center',
              minHeight: '96px'
            }}>
              {groups.length === 0 ? (
                /* æ— çƒç»„æ—¶çš„æé†’å¡ç‰‡ */
                <div style={{
                  textAlign: 'center',
                  padding: '20px',
                  color: '#9ca3af',
                  fontSize: '16px',
                  backgroundColor: '#f9fafb',
                  borderRadius: '8px',
                  border: '1px dashed #e5e7eb',
                  width: 'calc(100% - 15px)',
                  height: '81px',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <div style={{ marginBottom: '8px' }}>ğŸ¾</div>
                  <div>ç‚¹å‡» + æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªçƒ</div>
                </div>
              ) : (
                /* æœ‰çƒç»„æ—¶æ˜¾ç¤ºçƒç»„ç¼–å· */
                groups.map((g, i) => (
                  <div key={g.id} style={{ position: 'relative' }}>
                    <button
                      onClick={() => setSelectedIndex(i)}
                      style={{
                        width: '40px',
                        height: '40px',
                        borderRadius: '50%',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                        backgroundColor: i === selectedIndex ? 'white' : '#f3f4f6',
                        border: i === selectedIndex ? '2px solid #34d399' : 'none',
                        cursor: 'pointer'
                      }}
                    >
                      {i + 1}
                    </button>

                    {/* åˆ é™¤æ ‡è¯†ï¼šå½“è¯¥ç¼–å·è¢«é€‰ä¸­æ—¶æ˜¾ç¤ºåœ¨å³ä¸Šè§’ */}
                    {i === selectedIndex && (
                      <button
                        onClick={removeSelected}
                        style={{
                          position: 'absolute',
                          top: '-8px',
                          right: '-8px',
                          width: '24px',
                          height: '24px',
                          borderRadius: '50%',
                          backgroundColor: '#fef2f2',
                          color: '#dc2626',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          fontSize: '12px',
                          boxShadow: '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
                          cursor: 'pointer',
                          border: 'none'
                        }}
                        title="åˆ é™¤å½“å‰çƒç»„"
                      >
                        -
                      </button>
                    )}
                  </div>
                ))
              )}
            </div>

            {/* å‚æ•°åŒºåŸŸ - å§‹ç»ˆæ˜¾ç¤º */}
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              <ParamRow
                label="å‘çƒæ–¹å‘ (Â°)"
                min={-50}
                max={50}
                step={5}
                value={selectedGroup.direction}
                onChange={(v) => {
                  if (selectedIndex >= 0) {
                    updateSelected({ direction: v });
                  }
                }}
                format={(v) => `${v}Â°`}
              />

              <ParamRow
                label="ä¸Šå‘çƒè½®è½¬é€Ÿ (rpm)"
                min={2000}
                max={7000}
                step={500}
                value={selectedGroup.upperRpm}
                onChange={(v) => {
                  if (selectedIndex >= 0) {
                    updateSelected({ upperRpm: v });
                  }
                }}
                format={(v) => `${v} rpm`}
              />

              <ParamRow
                label="ä¸‹å‘çƒè½®è½¬é€Ÿ (rpm)"
                min={2000}
                max={7000}
                step={500}
                value={selectedGroup.lowerRpm}
                onChange={(v) => {
                  if (selectedIndex >= 0) {
                    updateSelected({ lowerRpm: v });
                  }
                }}
                format={(v) => `${v} rpm`}
              />

              <ParamRow
                label="ä¿¯ä»°è§’åº¦ (Â°)"
                min={20}
                max={40}
                step={2}
                value={selectedGroup.pitch}
                onChange={(v) => {
                  if (selectedIndex >= 0) {
                    updateSelected({ pitch: v });
                  }
                }}
                format={(v) => `${v}Â°`}
              />

              <ParamRow
                label="å‘çƒæ—¶é—´é—´éš” (s)"
                min={1}
                max={6}
                step={0.5}
                value={selectedGroup.interval}
                onChange={(v) => {
                  if (selectedIndex >= 0) {
                    updateSelected({ interval: v });
                  }
                }}
                format={(v) => v.toFixed(1)}
              />

              {/* Start/Stop æŒ‰é’® */}
              <div style={{ marginTop: '12px' }}>
                <button
                  onClick={toggleRun}
                  disabled={groups.length === 0}
                  style={{
                    width: '100%',
                    padding: '16px',
                    borderRadius: '12px',
                    color: groups.length === 0 ? '#9ca3af' : 'white',
                    fontSize: '18px',
                    fontWeight: '500',
                    backgroundColor: groups.length === 0 ? '#f3f4f6' : (running ? '#dc2626' : 'black'),
                    border: 'none',
                    cursor: groups.length === 0 ? 'not-allowed' : 'pointer'
                  }}
                >
                  {running ? "â¸ Stop" : "âµ Start"}
                </button>
              </div>
            </div>
          </div>
        </div>

        {/* åº•éƒ¨å¯¼èˆª */}
        <div style={{
          marginTop: '24px',
          backgroundColor: 'white',
          borderRadius: '12px',
          boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
          padding: '12px'
        }}>
          <nav style={{ display: 'flex', justifyContent: 'space-around' }}>
            <NavItem label="Rally" keyName="rally" active={nav === "rally"} onClick={() => setNav("rally")} />
            <NavItem label="Ball Machine" keyName="ball-machine" active={nav === "ball-machine"} onClick={() => setNav("ball-machine")} />
            <NavItem label="Training" keyName="training" active={nav === "training"} onClick={() => setNav("training")} />
            <NavItem label="Me" keyName="me" active={nav === "me"} onClick={() => setNav("me")} />
          </nav>
        </div>
      </div>
    </div>
  );
}

interface ParamRowProps {
  label: string;
  min: number;
  max: number;
  step: number;
  value: number;
  onChange: (value: number) => void;
  format?: (value: number) => string;
}

function ParamRow({ label, min, max, step, value, onChange, format }: ParamRowProps) {
  return (
    <div>
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        marginBottom: '4px'
      }}>
        <div style={{ fontSize: '14px' }}>{label}</div>
        <div style={{ fontSize: '14px', fontWeight: '500' }}>
          {format ? format(value) : value}
        </div>
      </div>
      <input
        type="range"
        style={{
          width: '100%',
          WebkitAppearance: 'none',
          appearance: 'none',
          height: '6px',
          borderRadius: '3px',
          background: '#e5e7eb',
          outline: 'none'
        }}
        min={min}
        max={max}
        step={step}
        value={value}
        onChange={(e) => {
          const v = Number(e.target.value);
          onChange(v);
        }}
      />
    </div>
  );
}

interface NavItemProps {
  label: string;
  keyName: string;
  active: boolean;
  onClick: () => void;
}

function NavItem({ label, keyName, active, onClick }: NavItemProps) {
  return (
    <button
      onClick={onClick}
      style={{
        flex: 1,
        padding: '8px',
        textAlign: 'center',
        color: active ? '#059669' : '#6b7280',
        fontWeight: active ? '600' : 'normal',
        border: 'none',
        backgroundColor: 'transparent',
        cursor: 'pointer',
        fontSize: '14px'
      }}
    >
      <div>{label}</div>
    </button>
  );
}